#!/usr/bin/env bash
# with-packages nix-wrapped cachix
set -x
ref=${1:-main}
output=${2:-homeConfigurations.$(hostname -s)}
link=/tmp/$output
build=github:kwbauson/cfg?ref=$ref#$output
lock=/tmp/building-from-github
if [[ -z $SELF_CALL ]];then
  SELF_CALL=1 exec nix shell $build -c build-from-github "$@"
else
  buildcmd="nix build -o $link $build"
  # try multiple builds in case of failure
  touch $lock
  $buildcmd --tarball-ttl 0
  for i in {2..10};do
    if [[ $? = 0 ]];then
      break
    else
      sleep 15
      [[ ! -e $lock ]] && $buildcmd
    fi
  done
fi
status=$?
[[ $status = 0 ]] && cachix push kwbauson $link
rm -f $lock
exit $status
