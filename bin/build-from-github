#!/usr/bin/env bash
# with-packages nix-wrapped cachix
set -x
ref=${1:-main}
output=${2:-homeConfigurations.$HOSTNAME}
link=/tmp/${output}_${ref}
build=github:kwbauson/cfg?ref=$ref#$output
if [[ -z $SELF_CALL ]];then
  SELF_CALL=1 exec nix shell $build -c build-from-github "$@"
else
  # try multiple builds in case of failure
  nix build --tarball-ttl 0 -o $link $build
  nix build -o $link $build
fi
status=$?
[[ $status = 0 ]] && cachix push kwbauson $link
exit $status
